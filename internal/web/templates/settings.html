<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/fa.min.css">
    <link rel="stylesheet" href="/style.css">
    <style>
        /* Hide content until translations are loaded to prevent flash of untranslated content */
        body { visibility: hidden; }
    </style>
    <script>
        (function() {
            const theme = localStorage.getItem('theme') || 'system';
            if (theme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
            } else if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else if (theme === 'light-green') {
                document.documentElement.setAttribute('data-theme', 'light-green');
            } else if (theme === 'light-blue') {
                document.documentElement.setAttribute('data-theme', 'light-blue');
            }
        })();
    </script>
    <title>PBAKTH Settings</title>
</head>
<body>
    <div class="container">
        <header>
            <div class="nav-bar">
                <a href="/">
                    <img src="/pwa/full_logo.png" alt="PBAKTH Logo" height="85" style="vertical-align: middle; margin-right: 20px;">
                </a>
                <a href="/" class="view-button" data-tooltip="Dashboard" data-i18n-tooltip="navigation.dashboard">
                    <i class="fa-solid fa-chart-pie"></i>
                </a>
                <a href="/table" class="view-button" data-tooltip="Table View" data-i18n-tooltip="navigation.table_view">
                    <i class="fa-solid fa-table"></i>
                </a>
                <a href="/summary" class="view-button" data-tooltip="Summary" data-i18n-tooltip="navigation.summary">
                    <i class="fa-solid fa-chart-column"></i>
                </a>
                {{if not .HideSettings}}
                <a href="/settings" class="view-button active" data-tooltip="Settings" data-i18n-tooltip="navigation.settings">
                    <i class="fa-solid fa-gear"></i>
                </a>
                {{end}}
            </div>
        </header>

        <div class="form-container">
            <h2 align="center" data-i18n="settings.category_settings">Category Settings</h2>
            <div id="categories-manager">
                <div id="categories-list" class="categories-list">
                </div>
                <div class="category-input-container">
                    <input type="text" id="newCategory" placeholder="Add new category" data-i18n="settings.add_new_category" data-i18n-attr="placeholder">
                    <button id="addCategory" class="nav-button" data-i18n="common.add">Add</button>
                </div>
                <button id="saveCategories" class="nav-button" data-i18n="settings.save_categories">Save Categories</button>
                <div id="categoriesMessage" class="form-message"></div>
            </div>
        </div>

        <div class="settings-container">
            <div class="form-container half-width">
                <h2 align="center" data-i18n="settings.currency_settings">Currency Settings</h2>
                <div class="currency-selector">
                    <select id="currencySelect">
                    </select>
                    <button id="saveCurrency" class="nav-button" data-i18n="common.save">Save</button>
                </div>
                <div id="currencyMessage" class="form-message"></div>
            </div>

            <div class="form-container half-width">
                <h2 align="center" data-i18n="settings.start_date_settings">Start Date Settings</h2>
                <div class="start-date-manager">
                    <input type="number" id="startDate" min="1" max="31" placeholder="1" data-i18n="settings.start_date_placeholder" data-i18n-attr="placeholder">
                    <button id="saveStartDate" class="nav-button" data-i18n="common.save">Save</button>
                </div>
                <div id="startDateMessage" class="form-message"></div>
            </div>
        </div>

        <div class="settings-container">
            <div class="form-container half-width">
                <h2 align="center" data-i18n="settings.opening_balance_settings">Opening Balance Settings</h2>
                <div class="start-date-manager">
                    <input type="number" id="openingBalance" step="0.01" placeholder="0.00" data-i18n="settings.opening_balance_placeholder" data-i18n-attr="placeholder">
                    <button id="saveOpeningBalance" class="nav-button" data-i18n="common.save">Save</button>
                </div>
                <div id="openingBalanceMessage" class="form-message"></div>
            </div>
        </div>

        <div class="settings-container">
            <div class="form-container half-width">
                <h2 align="center" data-i18n="settings.theme_settings">Theme Settings</h2>
                <div class="theme-selector">
                    <select id="themeSelect">
                        <option value="system" data-i18n="theme.system">System Default</option>
                        <option value="light" data-i18n="theme.light">Light</option>
                        <option value="dark" data-i18n="theme.dark">Dark</option>
                        <option value="light-green" data-i18n="theme.light_green">Light Green</option>
                        <option value="light-blue" data-i18n="theme.light_blue">Light Blue</option>
                    </select>
                </div>
                <div id="themeMessage" class="form-message"></div>
            </div>
            <div class="form-container half-width">
                <h2 align="center" data-i18n="settings.language_settings">Language Settings</h2>
                <div class="language-selector">
                    <select id="languageSelect">
                        <option value="en">English</option>
                        <option value="ms">Bahasa Malaysia</option>
                    </select>
                </div>
                <div id="languageMessage" class="form-message"></div>
            </div>
        </div>

        <div class="settings-container">
            <div class="form-container half-width">
                <h2 align="center" data-i18n="settings.import_export">Import/Export Data</h2>
                <div class="export-buttons">
                    <div class="export-options">
                        <a href="/export/csv" id="csv-export-file" class="nav-button" download="expenses.csv" data-i18n="settings.export_csv">Export to CSV</a>
                    </div>
                    <div class="import-option">
                        <label for="csv-import-file" class="nav-button" data-i18n="settings.import_csv">Import from CSV</label>
                        <input type="file" id="csv-import-file" accept=".csv" style="display: none;">
                    </div>
                </div>
                <div id="importMessage" class="form-message"></div>
                <div id="importSummary" class="import-summary" style="display: none;">
                    <h3 data-i18n="import.summary">Import Summary</h3>
                    <p><span data-i18n="import.total_processed">Total Processed:</span> <span id="summary-processed"></span></p>
                    <p><span data-i18n="import.imported">Imported:</span> <span id="summary-imported"></span></p>
                    <p><span data-i18n="import.skipped">Skipped:</span> <span id="summary-skipped"></span></p>
                    <p><span data-i18n="import.new_categories">New Categories:</span> <span id="summary-new-categories"></span></p>
                </div>
            </div>
        </div>
    </div>

    <script src="/functions.js"></script>
    <script>
        let categories = [];
        let currentCurrency = "usd";
        let currentStartDate = 1;
        let draggedItem = null;

        function showMessage(elementId, message, isSuccess) {
            const messageDiv = document.getElementById(elementId);
            messageDiv.textContent = message;
            messageDiv.className = isSuccess ? 'form-message success' : 'form-message error';
            setTimeout(() => {
                messageDiv.textContent = '';
                messageDiv.className = 'form-message';
            }, 3000);
        }

        // --- Category Management ---
        function renderCategories() {
            const list = document.getElementById('categories-list');
            list.innerHTML = '';
            categories.forEach((category, index) => {
                const item = document.createElement('div');
                item.className = 'category-item';
                item.draggable = true;
                item.dataset.index = index;
                item.innerHTML = `
                    <div class="category-handle-area">
                        <span class="drag-handle"><i class="fa-solid fa-grip-lines"></i></span>
                        <span class="category-name" id="category-name-${index}">${category}</span>
                        <input type="text" class="category-rename-input" id="category-input-${index}" value="${category}" style="display:none;">
                    </div>
                    <div class="category-actions">
                        <button class="edit-button" id="edit-btn-${index}" onclick="startRenameCategory(${index})" data-tooltip="Rename">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                        <button class="save-rename-button" id="save-btn-${index}" onclick="saveRenameCategory(${index})" style="display:none;" data-tooltip="Save">
                            <i class="fa-solid fa-check"></i>
                        </button>
                        <button class="cancel-rename-button" id="cancel-btn-${index}" onclick="cancelRenameCategory(${index})" style="display:none;" data-tooltip="Cancel">
                            <i class="fa-solid fa-times"></i>
                        </button>
                        <button class="delete-button" id="delete-btn-${index}" onclick="removeCategory(${index})" data-tooltip="Delete">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                `;
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('dragleave', handleDragLeave);
                item.addEventListener('dragend', handleDragEnd);
                item.addEventListener('drop', handleDrop);
                list.appendChild(item);
            });
        }

        function handleDragStart(e) {
            this.classList.add('dragging');
            draggedItem = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
            removePlaceholders();
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            this.classList.add('drag-over');
            if (this === draggedItem) return false;
            const rect = this.getBoundingClientRect();
            const clientY = e.clientY;
            const threshold = rect.top + (rect.height / 2);
            const isBefore = clientY < threshold;
            removePlaceholders();
            const placeholder = document.createElement('div');
            placeholder.className = 'placeholder';
            if (isBefore) {
                this.parentNode.insertBefore(placeholder, this);
            } else {
                this.parentNode.insertBefore(placeholder, this.nextSibling);
            }
            return false;
        }

        function handleDragLeave() { this.classList.remove('drag-over'); }
        function handleDragEnd() {
            this.classList.remove('dragging');
            document.querySelectorAll('.category-item, .tag-item').forEach(item => item.classList.remove('drag-over'));
            removePlaceholders();
        }
        function removePlaceholders() { document.querySelectorAll('.placeholder').forEach(p => p.remove()); }

        function handleDrop(e) {
            e.stopPropagation();
            e.preventDefault();
            removePlaceholders();
            if (draggedItem !== this) {
                const fromIndex = parseInt(draggedItem.dataset.index, 10);
                let toIndex = parseInt(this.dataset.index, 10);
                const rect = this.getBoundingClientRect();
                const isBefore = e.clientY < rect.top + rect.height / 2;
                if (!isBefore) toIndex++;
                if (fromIndex < toIndex) toIndex--;
                const list = categories;
                const movedItem = list.splice(fromIndex, 1)[0];
                list.splice(toIndex, 0, movedItem);
                renderCategories();
            }
            return false;
        }

        function addCategory() {
            const input = document.getElementById('newCategory');
            let category = input.value.trim();
            category = category.replace(/[<>]/g, ' ').trim();
            if (category && !categories.includes(category)) {
                categories.push(category);
                renderCategories();
                input.value = '';
            } else if (categories.includes(category)) {
                showMessage('categoriesMessage', 'Category already exists', false);
            } else if (!category) {
                showMessage('categoriesMessage', 'Category name cannot be empty.', false);
            }
        }

        function removeCategory(index) {
            categories.splice(index, 1);
            renderCategories();
        }

        function startRenameCategory(index) {
            const nameSpan = document.getElementById(`category-name-${index}`);
            const input = document.getElementById(`category-input-${index}`);
            const editBtn = document.getElementById(`edit-btn-${index}`);
            const saveBtn = document.getElementById(`save-btn-${index}`);
            const cancelBtn = document.getElementById(`cancel-btn-${index}`);
            const deleteBtn = document.getElementById(`delete-btn-${index}`);

            nameSpan.style.display = 'none';
            input.style.display = 'inline-block';
            input.focus();
            input.select();

            editBtn.style.display = 'none';
            deleteBtn.style.display = 'none';
            saveBtn.style.display = 'inline-block';
            cancelBtn.style.display = 'inline-block';
        }

        function cancelRenameCategory(index) {
            const nameSpan = document.getElementById(`category-name-${index}`);
            const input = document.getElementById(`category-input-${index}`);
            const editBtn = document.getElementById(`edit-btn-${index}`);
            const saveBtn = document.getElementById(`save-btn-${index}`);
            const cancelBtn = document.getElementById(`cancel-btn-${index}`);
            const deleteBtn = document.getElementById(`delete-btn-${index}`);

            input.value = categories[index];
            nameSpan.style.display = 'inline';
            input.style.display = 'none';

            editBtn.style.display = 'inline-block';
            deleteBtn.style.display = 'inline-block';
            saveBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
        }

        async function saveRenameCategory(index) {
            const input = document.getElementById(`category-input-${index}`);
            let newName = input.value.trim();
            newName = newName.replace(/[<>]/g, ' ').trim();
            const oldName = categories[index];

            if (!newName) {
                showMessage('categoriesMessage', 'Category name cannot be empty', false);
                return;
            }

            if (newName === oldName) {
                cancelRenameCategory(index);
                return;
            }

            if (categories.includes(newName)) {
                showMessage('categoriesMessage', 'Category name already exists', false);
                return;
            }

            try {
                const response = await fetch('/categories/rename', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ oldName, newName })
                });

                if (response.ok) {
                    categories[index] = newName;
                    renderCategories();
                    showMessage('categoriesMessage', 'Category renamed successfully', true);
                } else {
                    const error = await response.json();
                    showMessage('categoriesMessage', `Failed to rename category: ${error.error}`, false);
                }
            } catch (error) {
                console.error('Error renaming category:', error);
                showMessage('categoriesMessage', 'Error renaming category', false);
            }
        }

        async function saveCategories() {
            if (categories.length === 0) {
                showMessage('categoriesMessage', 'At least one category is required', false);
                return;
            }
            try {
                const response = await fetch('/categories/edit', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(categories)
                });   
                if (response.ok) {
                    showMessage('categoriesMessage', 'Categories saved successfully', true);
                } else {
                    const error = await response.json();
                    showMessage('categoriesMessage', `Failed to save categories: ${error.error}`, false);
                }
            } catch (error) {
                console.error('Error saving categories:', error);
                showMessage('categoriesMessage', 'Error saving categories', false);
            }
        }

        // --- Currency & Start Date ---
        function populateCurrencySelect() {
            const select = document.getElementById('currencySelect');
            select.innerHTML = Object.keys(currencyBehaviors).map(code => 
                `<option value="${code}" ${code === currentCurrency ? 'selected' : ''}>
                    ${code.toUpperCase()} (${currencyBehaviors[code].symbol})
                </option>`
            ).join('');
        }
        
        async function saveCurrency() {
            const currencyCode = document.getElementById('currencySelect').value;
            try {
                const response = await fetch('/currency/edit', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currencyCode)
                });
                if (response.ok) {
                    showMessage('currencyMessage', 'Currency saved successfully', true);
                    currentCurrency = currencyCode;
                } else {
                    showMessage('currencyMessage', 'Failed to save currency', false);
                }
            } catch (error) {
                console.error('Error saving currency:', error);
                showMessage('currencyMessage', 'Error saving currency', false);
            }
        }

        function populateStartDateInput() {
            document.getElementById("startDate").value = currentStartDate;
        }

        async function saveStartDate() {
            const startDateValue = document.getElementById("startDate").value;
            try {
                const response = await fetch('/startdate/edit', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(parseInt(startDateValue, 10))
                });
                showMessage('startDateMessage', response.ok ? 'Start date saved successfully' : 'Failed to save start date', response.ok);
            } catch (error) {
                console.error('Error saving start date:', error);
                showMessage('startDateMessage', 'Error saving start date', false);
            }
        }

        async function saveOpeningBalance() {
            const balance = parseFloat(document.getElementById('openingBalance').value) || 0;
            try {
                const response = await fetch('/openingbalance/edit', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(balance)
                });
                showMessage('openingBalanceMessage', response.ok ? 'Opening balance saved successfully' : 'Failed to save opening balance', response.ok);
            } catch (error) {
                console.error('Error saving opening balance:', error);
                showMessage('openingBalanceMessage', 'Error saving opening balance', false);
            }
        }

        // --- Import/Export ---
        async function handleCsvImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append('file', file);
            const messageDiv = document.getElementById('importMessage');
            const summaryDiv = document.getElementById('importSummary');

            messageDiv.textContent = 'Importing... this may take a while for large files.';
            messageDiv.className = 'form-message';
            summaryDiv.style.display = 'none';

            try {
                const response = await fetch('/import/csv', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    messageDiv.textContent = 'Import completed!';
                    messageDiv.className = 'form-message success';
                    summaryDiv.style.display = 'block';
                    document.getElementById('summary-processed').textContent = result.total_processed;
                    document.getElementById('summary-imported').textContent = result.imported;
                    document.getElementById('summary-skipped').textContent = result.skipped;
                    document.getElementById('summary-new-categories').textContent = (result.new_categories || []).join(', ') || 'None';
                    
                    await initialize();
                } else {
                    messageDiv.textContent = `Error: ${result.error || 'Failed to import CSV'}`;
                    messageDiv.className = 'form-message error';
                }
            } catch (error) {
                console.error('Error importing CSV:', error);
                messageDiv.textContent = 'Error: An unexpected error occurred during import.';
                messageDiv.className = 'form-message error';
            } finally {
                event.target.value = '';
            }
        }

        // TODO: remove in the future; handles import from EO < v3.20
        async function handleCsvImportOld(event) {
            const file = event.target.files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append('file', file);
            const messageDiv = document.getElementById('importMessage');
            const summaryDiv = document.getElementById('importSummary');

            messageDiv.textContent = 'Importing... this may take a while for large files.';
            messageDiv.className = 'form-message';
            summaryDiv.style.display = 'none';

            try {
                const response = await fetch('/import/csvold', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    messageDiv.textContent = 'Import completed!';
                    messageDiv.className = 'form-message success';
                    summaryDiv.style.display = 'block';
                    document.getElementById('summary-processed').textContent = result.total_processed;
                    document.getElementById('summary-imported').textContent = result.imported;
                    document.getElementById('summary-skipped').textContent = result.skipped;
                    document.getElementById('summary-new-categories').textContent = (result.new_categories || []).join(', ') || 'None';
                    
                    await initialize();
                } else {
                    messageDiv.textContent = `Error: ${result.error || 'Failed to import CSV'}`;
                    messageDiv.className = 'form-message error';
                }
            } catch (error) {
                console.error('Error importing CSV:', error);
                messageDiv.textContent = 'Error: An unexpected error occurred during import.';
                messageDiv.className = 'form-message error';
            } finally {
                event.target.value = '';
            }
        }

        // --- Initialization ---
        async function initialize() {
            await initI18n();
            document.getElementById('languageSelect').value = currentLanguage;
            try {
                const [configResponse, expensesResponse] = await Promise.all([
                    fetch('/config'),
                    fetch('/expenses')
                ]);
                if (!configResponse.ok) throw new Error('Failed to fetch configuration');
                const config = await configResponse.json();
                if (!expensesResponse.ok) throw new Error('Failed to fetch expenses');
                const expenses = await expensesResponse.json();

                categories = [...config.categories];
                currentCurrency = config.currency;
                currentStartDate = config.startDate;
                document.getElementById('openingBalance').value = config.openingBalance || 0;

                renderCategories();
                populateCurrencySelect();
                populateStartDateInput();

                fetch('/version').then(r => r.ok ? r.text() : 'dev').then(version => {
                    const link = document.getElementById('version-link');
                    if (link) {
                        link.textContent = version;
                        if (version !== 'dev') link.href = `https://github.com/tanq16/expenseowl/releases/tag/${version}`;
                    }
                }).catch(e => console.error('Failed to fetch version:', e));

            } catch (error) {
                console.error('Failed to initialize settings:', error);
                showMessage('categoriesMessage', 'Failed to load settings', false);
            }
        }
        
        // --- Theme Management ---
        const themeSelect = document.getElementById('themeSelect');
        const currentTheme = localStorage.getItem('theme') || 'system';
        themeSelect.value = currentTheme;
        function applyTheme(theme) {
            if (theme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
            } else if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else if (theme === 'light-green') {
                document.documentElement.setAttribute('data-theme', 'light-green');
            } else if (theme === 'light-blue') {
                document.documentElement.setAttribute('data-theme', 'light-blue');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
        }
        themeSelect.addEventListener('change', (e) => {
            const selectedTheme = e.target.value;
            localStorage.setItem('theme', selectedTheme);
            applyTheme(selectedTheme);
            showMessage('themeMessage', t('settings.theme_updated', 'Theme updated successfully.'), true);
        });

        // --- Language Settings ---
        const languageSelect = document.getElementById('languageSelect');
        languageSelect.addEventListener('change', async (e) => {
            const selectedLanguage = e.target.value;
            const success = await setLanguage(selectedLanguage);
            if (success) {
                showMessage('languageMessage', t('settings.language_updated', 'Language updated successfully.'), true);
            } else {
                showMessage('languageMessage', 'Failed to update language.', false);
            }
        });

        // --- Event Listeners ---
        document.getElementById('addCategory').addEventListener('click', addCategory);
        document.getElementById('saveCategories').addEventListener('click', saveCategories);
        document.getElementById('saveCurrency').addEventListener('click', saveCurrency);
        document.getElementById('saveStartDate').addEventListener('click', saveStartDate);
        document.getElementById('saveOpeningBalance').addEventListener('click', saveOpeningBalance);
        document.getElementById('csv-import-file').addEventListener('change', handleCsvImport);
        const csvImportOld = document.getElementById('csv-import-file-old');
        if (csvImportOld) {
            csvImportOld.addEventListener('change', handleCsvImportOld);
        }
        document.getElementById('newCategory').addEventListener('keypress', e => e.key === 'Enter' && addCategory());

        document.addEventListener('DOMContentLoaded', initialize);
        window.removeCategory = removeCategory;
    </script>
</body>
</html>
