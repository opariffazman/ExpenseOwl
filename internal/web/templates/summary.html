<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/fa.min.css">
    <link rel="stylesheet" href="/style.css">
    <script>
        (function() {
            const theme = localStorage.getItem('theme') || 'system';
            if (theme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
            } else if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else if (theme === 'light-green') {
                document.documentElement.setAttribute('data-theme', 'light-green');
            } else if (theme === 'light-blue') {
                document.documentElement.setAttribute('data-theme', 'light-blue');
            }
        })();
    </script>
    <title>PBAKTH Summary</title>
    <style>
        /* Hide content until translations are loaded to prevent flash of untranslated content */
        body { visibility: hidden; }

        .summary-section {
            margin: 20px 0;
        }
        .summary-section h2 {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .no-data {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
            font-style: italic;
        }
        .expense-table th {
            cursor: pointer;
            user-select: none;
        }
        .expense-table th:hover {
            background: var(--hover-color);
        }
        .expense-table th.sorted-asc::after {
            content: ' ▲';
            font-size: 0.8em;
        }
        .expense-table th.sorted-desc::after {
            content: ' ▼';
            font-size: 0.8em;
        }
        .expense-table td.amount,
        .expense-table th.amount,
        .expense-table tfoot td:last-child {
            text-align: right;
        }
        .expense-table tfoot td {
            font-weight: bold;
        }
        @media (max-width: 768px) {
            .summary-section {
                margin: 15px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="nav-bar">
                <a href="/">
                    <img src="/pwa/full_logo.png" alt="PBAKTH Logo" height="85" style="vertical-align: middle; margin-right: 20px;">
                </a>
                <a href="/" class="view-button" data-tooltip="Dashboard" data-i18n-tooltip="navigation.dashboard">
                    <i class="fa-solid fa-chart-pie"></i>
                </a>
                <a href="/table" class="view-button" data-tooltip="Table View" data-i18n-tooltip="navigation.table_view">
                    <i class="fa-solid fa-table"></i>
                </a>
                <a href="/summary" class="view-button active" data-tooltip="Summary" data-i18n-tooltip="navigation.summary">
                    <i class="fa-solid fa-chart-column"></i>
                </a>
                {{if not .HideSettings}}
                <a href="/settings" class="view-button" data-tooltip="Settings" data-i18n-tooltip="navigation.settings">
                    <i class="fa-solid fa-gear"></i>
                </a>
                {{end}}
            </div>
        </header>

        <div class="month-navigation">
            <button id="prevMonth" class="nav-button"><i class="fa-solid fa-arrow-left"></i></button>
            <div class="current-month" id="currentMonth"></div>
            <button id="nextMonth" class="nav-button"><i class="fa-solid fa-arrow-right"></i></button>
        </div>

        <div class="table-controls">
            <label for="showLatestToggle">
                <input type="checkbox" id="showLatestToggle" class="styled-checkbox"> <span data-i18n="summary.show_latest">Show Latest Summary</span>
            </label>
            <label for="useManualBalancesToggle" style="margin-left: 15px;">
                <input type="checkbox" id="useManualBalancesToggle" class="styled-checkbox"> <span data-i18n="summary.use_manual_balances">Use Manual Balances</span>
            </label>
            <button id="generateStatementBtn" class="nav-button" style="margin-left: auto;">
                <i class="fa-solid fa-file-pdf"></i> <span data-i18n="summary.generate_statement">Generate Statement</span>
            </button>
        </div>

        <div class="summary-section">
            <h2><i class="fa-solid fa-chart-column"></i> <span data-i18n="summary.category_summary">Category Summary</span></h2>
            <div id="summaryTableContainer"></div>
        </div>
    </div>

    <script src="/functions.js"></script>
    <script>
        let currentCurrency = 'usd';
        let currentDate = new Date();
        let allExpenses = [];
        let startDate = 1;
        let sortColumn = 'balance';
        let sortAscending = false;
        let useManualBalances = false;
        let manualBalances = {};

        function calculateCategorySummary(expenses) {
            const categoryMap = new Map();

            expenses.forEach(exp => {
                const amount = exp.amount;
                const category = exp.category || 'Uncategorized';

                if (!categoryMap.has(category)) {
                    categoryMap.set(category, { gains: 0, expenses: 0, balance: 0 });
                }
                const entry = categoryMap.get(category);

                if (amount > 0) {
                    entry.gains += amount;
                } else if (amount < 0) {
                    entry.expenses += Math.abs(amount);
                }
                entry.balance = entry.gains - entry.expenses;
            });

            // Convert to array and calculate totals
            let totalGains = 0;
            let totalExpenses = 0;

            const categoryData = Array.from(categoryMap.entries()).map(([category, data]) => {
                totalGains += data.gains;
                totalExpenses += data.expenses;
                return {
                    category,
                    gains: data.gains,
                    expenses: data.expenses,
                    balance: data.balance
                };
            });

            return {
                categoryData,
                totalGains,
                totalExpenses,
                netBalance: totalGains - totalExpenses
            };
        }

        function sortTableData(data, column, ascending) {
            return data.slice().sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];

                if (column === 'category') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }

                if (aVal < bVal) return ascending ? -1 : 1;
                if (aVal > bVal) return ascending ? 1 : -1;
                return 0;
            });
        }

        function createSummaryTable(data, summary) {
            if (!data || data.length === 0) {
                return `<div class="no-data">${t('summary.no_data', 'No data recorded for this month')}</div>`;
            }

            const sortedData = sortTableData(data, sortColumn, sortAscending);
            const showManualColumn = useManualBalances;

            return `
                <table class="expense-table">
                    <thead>
                        <tr>
                            <th onclick="handleSort('category')" class="${sortColumn === 'category' ? (sortAscending ? 'sorted-asc' : 'sorted-desc') : ''}">${t('summary.category', 'Category')}</th>
                            <th onclick="handleSort('gains')" class="amount ${sortColumn === 'gains' ? (sortAscending ? 'sorted-asc' : 'sorted-desc') : ''}">${t('summary.gains', 'Gains')}</th>
                            <th onclick="handleSort('expenses')" class="amount ${sortColumn === 'expenses' ? (sortAscending ? 'sorted-asc' : 'sorted-desc') : ''}">${t('summary.expenses', 'Expenses')}</th>
                            <th onclick="handleSort('balance')" class="amount ${sortColumn === 'balance' ? (sortAscending ? 'sorted-asc' : 'sorted-desc') : ''}">${t('summary.balance', 'Balance')}</th>
                            ${showManualColumn ? `<th class="amount">${t('summary.manual_balance', 'Manual Balance')}</th>` : ''}
                            ${showManualColumn ? `<th class="amount">${t('summary.final_balance', 'Final Balance')}</th>` : ''}
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedData.map(row => {
                            const manualBalance = manualBalances[row.category] || 0;
                            const finalBalance = row.balance + manualBalance;
                            return `
                                <tr>
                                    <td>${escapeHTML(row.category)}</td>
                                    <td class="amount">${row.gains > 0 ? formatCurrency(row.gains) : '-'}</td>
                                    <td class="amount">${row.expenses > 0 ? formatCurrency(row.expenses) : '-'}</td>
                                    <td class="amount" style="color: ${row.balance >= 0 ? '#28a745' : '#dc3545'}; font-weight: bold;">${formatCurrency(row.balance)}</td>
                                    ${showManualColumn ? `<td class="amount"><input type="number" step="0.01" value="${manualBalance}" onchange="updateManualBalance('${row.category}', this.value)" style="width: 100px; text-align: right;"></td>` : ''}
                                    ${showManualColumn ? `<td class="amount" style="color: ${finalBalance >= 0 ? '#28a745' : '#dc3545'}; font-weight: bold;">${formatCurrency(finalBalance)}</td>` : ''}
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                    <tfoot>
                        <tr style="font-weight: bold;">
                            <td>${t('summary.total', 'TOTAL')}</td>
                            <td class="amount">${formatCurrency(summary.totalGains)}</td>
                            <td class="amount">${formatCurrency(summary.totalExpenses)}</td>
                            <td class="amount" style="color: ${summary.netBalance >= 0 ? '#28a745' : '#dc3545'};">${formatCurrency(summary.netBalance)}</td>
                            ${showManualColumn ? `<td class="amount">${formatCurrency(Object.values(manualBalances).reduce((sum, val) => sum + val, 0))}</td>` : ''}
                            ${showManualColumn ? `<td class="amount" style="color: ${(summary.netBalance + Object.values(manualBalances).reduce((sum, val) => sum + val, 0)) >= 0 ? '#28a745' : '#dc3545'};">${formatCurrency(summary.netBalance + Object.values(manualBalances).reduce((sum, val) => sum + val, 0))}</td>` : ''}
                        </tr>
                    </tfoot>
                </table>
            `;
        }

        async function updateManualBalance(category, value) {
            const numValue = parseFloat(value) || 0;
            manualBalances[category] = numValue;

            try {
                const response = await fetch('/manualbalances/edit', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(manualBalances)
                });

                if (!response.ok) throw new Error('Failed to save manual balances');
                updateSummary();
            } catch (error) {
                console.error('Error saving manual balance:', error);
                alert('Failed to save manual balance. Please try again.');
            }
        }

        function handleSort(column) {
            if (sortColumn === column) {
                sortAscending = !sortAscending;
            } else {
                sortColumn = column;
                sortAscending = column === 'category'; // Ascending for category, descending for numbers
            }
            updateSummary();
        }

        function getLatestExpenses(expenses) {
            const today = new Date();
            today.setHours(23, 59, 59, 999);

            return expenses.filter(exp => {
                const expDate = new Date(exp.date);
                return expDate <= today;
            });
        }

        function updateSummary() {
            const showLatest = document.getElementById('showLatestToggle').checked;
            const expensesToShow = showLatest ? getLatestExpenses(allExpenses) : getMonthExpenses(allExpenses);
            const summary = calculateCategorySummary(expensesToShow);

            document.getElementById('summaryTableContainer').innerHTML = createSummaryTable(summary.categoryData, summary);
        }

        function updateMonthDisplayCustom() {
            const showLatest = document.getElementById('showLatestToggle').checked;
            const monthNavigation = document.querySelector('.month-navigation');

            if (showLatest) {
                monthNavigation.style.display = 'none';
                document.getElementById('currentMonth').textContent = t('summary.latest_summary', 'Latest Summary');
            } else {
                monthNavigation.style.display = 'flex';
                updateMonthDisplay();
            }
        }

        async function initialize() {
            await initI18n();

            try {
                const configResponse = await fetch('/config');
                if (!configResponse.ok) throw new Error('Failed to fetch configuration');
                const config = await configResponse.json();
                currentCurrency = config.currency;
                startDate = config.startDate;
                useManualBalances = config.useManualBalances || false;
                manualBalances = config.manualBalances || {};

                document.getElementById('useManualBalancesToggle').checked = useManualBalances;

                const response = await fetch('/expenses');
                if (!response.ok) throw new Error('Failed to fetch data');
                const data = await response.json();
                allExpenses = Array.isArray(data) ? data : (data && Array.isArray(data.expenses) ? data.expenses : []);

                updateMonthDisplayCustom();
                updateSummary();
            } catch (error) {
                console.error('Failed to initialize summary:', error);
                const errorMsg = `<div class="no-data">${t('messages.failed_load', 'Failed to load summary data')}</div>`;
                document.getElementById('summaryTableContainer').innerHTML = errorMsg;
            }
        }

        document.getElementById('showLatestToggle').addEventListener('change', () => {
            updateMonthDisplayCustom();
            updateSummary();
        });

        document.getElementById('useManualBalancesToggle').addEventListener('change', async (e) => {
            useManualBalances = e.target.checked;

            try {
                const response = await fetch('/usemanualbalances/edit', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(useManualBalances)
                });

                if (!response.ok) throw new Error('Failed to update use manual balances setting');
                updateSummary();
            } catch (error) {
                console.error('Error updating manual balances setting:', error);
                alert('Failed to update setting. Please try again.');
                e.target.checked = !useManualBalances;
            }
        });

        document.getElementById('prevMonth').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            updateMonthDisplayCustom();
            updateSummary();
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            updateMonthDisplayCustom();
            updateSummary();
        });

        document.getElementById('generateStatementBtn').addEventListener('click', async () => {
            try {
                // Always use all expenses (latest view - full fiscal year)
                const expensesToShow = getLatestExpenses(allExpenses);

                // Get current year for fiscal year range
                const currentYear = new Date().getFullYear();
                const fiscalYearStart = new Date(currentYear, 0, 1); // Jan 1
                const fiscalYearEnd = new Date(currentYear, 11, 31); // Dec 31

                // Prepare statement data
                const statementData = {
                    startDate: fiscalYearStart.toISOString(),
                    endDate: fiscalYearEnd.toISOString(),
                    expenses: expensesToShow
                };

                const response = await fetch('/statement/pdf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(statementData)
                });

                if (!response.ok) throw new Error('Failed to generate statement');

                // Download the PDF
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `statement-${currentYear}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                console.error('Error generating statement:', error);
                alert('Failed to generate statement. Please try again.');
            }
        });

        initialize();
    </script>
</body>
</html>
