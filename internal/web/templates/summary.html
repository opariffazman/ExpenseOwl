<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/fa.min.css">
    <link rel="stylesheet" href="/style.css">
    <script>
        (function() {
            const theme = localStorage.getItem('theme') || 'system';
            if (theme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
            } else if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
    </script>
    <title>ExpenseOwl Summary</title>
    <style>
        .summary-section {
            margin: 20px 0;
        }
        .summary-section h2 {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .income-section h2 {
            color: #28a745;
        }
        .expense-section h2 {
            color: #dc3545;
        }
        .monthly-summary-box {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 20px;
            margin: 30px 0;
            border: 1px solid var(--border-color);
        }
        .monthly-summary-box h2 {
            margin-top: 0;
            margin-bottom: 20px;
            text-align: center;
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .summary-row:last-child {
            border-bottom: none;
        }
        .summary-label {
            font-weight: 500;
        }
        .summary-value {
            font-weight: 600;
        }
        .summary-value.positive {
            color: #28a745;
        }
        .summary-value.negative {
            color: #dc3545;
        }
        .no-data {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
            font-style: italic;
        }
        .expense-table th {
            cursor: pointer;
            user-select: none;
        }
        .expense-table th:hover {
            background: var(--hover-color);
        }
        .expense-table th.sorted-asc::after {
            content: ' ▲';
            font-size: 0.8em;
        }
        .expense-table th.sorted-desc::after {
            content: ' ▼';
            font-size: 0.8em;
        }
        @media (max-width: 768px) {
            .monthly-summary-box {
                padding: 15px;
            }
            .summary-row {
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="nav-bar">
                <a href="/">
                    <img src="/pwa/icon-192.png" alt="ExpenseOwl Logo" height="85" style="vertical-align: middle; margin-right: 20px;">
                </a>
                <a href="/" class="view-button" data-tooltip="Dashboard" data-i18n-tooltip="navigation.dashboard">
                    <i class="fa-solid fa-chart-pie"></i>
                </a>
                <a href="/table" class="view-button" data-tooltip="Table View" data-i18n-tooltip="navigation.table_view">
                    <i class="fa-solid fa-table"></i>
                </a>
                <a href="/summary" class="view-button active" data-tooltip="Summary" data-i18n-tooltip="navigation.summary">
                    <i class="fa-solid fa-chart-column"></i>
                </a>
                {{if not .HideSettings}}
                <a href="/settings" class="view-button" data-tooltip="Settings" data-i18n-tooltip="navigation.settings">
                    <i class="fa-solid fa-gear"></i>
                </a>
                {{end}}
            </div>
        </header>

        <div class="month-navigation">
            <button id="prevMonth" class="nav-button"><i class="fa-solid fa-arrow-left"></i></button>
            <div class="current-month" id="currentMonth"></div>
            <button id="nextMonth" class="nav-button"><i class="fa-solid fa-arrow-right"></i></button>
        </div>

        <div class="monthly-summary-box">
            <h2 data-i18n="summary.monthly_summary">Monthly Summary</h2>
            <div id="summaryStats"></div>
        </div>

        <div class="summary-section expense-section">
            <h2><i class="fa-solid fa-arrow-down"></i> <span data-i18n="summary.expense_breakdown">Expense Breakdown</span></h2>
            <div id="expenseTableContainer"></div>
        </div>

        <div class="summary-section income-section">
            <h2><i class="fa-solid fa-arrow-up"></i> <span data-i18n="summary.income_breakdown">Income Breakdown</span></h2>
            <div id="incomeTableContainer"></div>
        </div>
    </div>

    <script src="/functions.js"></script>
    <script>
        let currentCurrency = 'usd';
        let currentDate = new Date();
        let allExpenses = [];
        let startDate = 1;
        let sortColumn = 'amount';
        let sortAscending = false;

        function calculateCategorySummary(expenses) {
            const incomeMap = new Map();
            const expenseMap = new Map();

            expenses.forEach(exp => {
                const amount = exp.amount;
                const category = exp.category || 'Uncategorized';

                if (amount > 0) {
                    // Income
                    if (!incomeMap.has(category)) {
                        incomeMap.set(category, { total: 0, count: 0 });
                    }
                    const entry = incomeMap.get(category);
                    entry.total += amount;
                    entry.count += 1;
                } else if (amount < 0) {
                    // Expense
                    if (!expenseMap.has(category)) {
                        expenseMap.set(category, { total: 0, count: 0 });
                    }
                    const entry = expenseMap.get(category);
                    entry.total += Math.abs(amount);
                    entry.count += 1;
                }
            });

            // Convert to arrays and calculate percentages
            const totalIncome = Array.from(incomeMap.values()).reduce((sum, e) => sum + e.total, 0);
            const totalExpenses = Array.from(expenseMap.values()).reduce((sum, e) => sum + e.total, 0);

            const incomeData = Array.from(incomeMap.entries()).map(([category, data]) => ({
                category,
                total: data.total,
                count: data.count,
                average: data.count > 0 ? data.total / data.count : 0,
                percentage: totalIncome > 0 ? (data.total / totalIncome) * 100 : 0
            }));

            const expenseData = Array.from(expenseMap.entries()).map(([category, data]) => ({
                category,
                total: data.total,
                count: data.count,
                average: data.count > 0 ? data.total / data.count : 0,
                percentage: totalExpenses > 0 ? (data.total / totalExpenses) * 100 : 0
            }));

            return {
                incomeData,
                expenseData,
                totalIncome,
                totalExpenses,
                netBalance: totalIncome - totalExpenses,
                savingsRate: totalIncome > 0 ? ((totalIncome - totalExpenses) / totalIncome) * 100 : 0
            };
        }

        function sortTableData(data, column, ascending) {
            return data.slice().sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];

                if (column === 'category') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }

                if (aVal < bVal) return ascending ? -1 : 1;
                if (aVal > bVal) return ascending ? 1 : -1;
                return 0;
            });
        }

        function createSummaryTable(data, type) {
            if (!data || data.length === 0) {
                const messageKey = type === 'expenses' ? 'summary.no_expenses' : 'summary.no_income';
                const fallback = `No ${type} recorded for this month`;
                return `<div class="no-data">${t(messageKey, fallback)}</div>`;
            }

            const sortedData = sortTableData(data, sortColumn, sortAscending);
            const total = sortedData.reduce((sum, row) => sum + row.total, 0);
            const totalLabel = type === 'expenses' ? t('summary.total_expenses', 'TOTAL EXPENSES') : t('summary.total_income', 'TOTAL INCOME');

            return `
                <table class="expense-table">
                    <thead>
                        <tr>
                            <th onclick="handleSort('category')" class="${sortColumn === 'category' ? (sortAscending ? 'sorted-asc' : 'sorted-desc') : ''}">${t('summary.category', 'Category')}</th>
                            <th onclick="handleSort('total')" class="${sortColumn === 'total' ? (sortAscending ? 'sorted-asc' : 'sorted-desc') : ''}">${t('summary.amount', 'Amount')}</th>
                            <th onclick="handleSort('percentage')" class="${sortColumn === 'percentage' ? (sortAscending ? 'sorted-asc' : 'sorted-desc') : ''}">${t('summary.percentage', '% of Total')}</th>
                            <th onclick="handleSort('count')" class="${sortColumn === 'count' ? (sortAscending ? 'sorted-asc' : 'sorted-desc') : ''}">${t('summary.count', 'Count')}</th>
                            <th onclick="handleSort('average')" class="${sortColumn === 'average' ? (sortAscending ? 'sorted-asc' : 'sorted-desc') : ''}">${t('summary.average', 'Avg/Transaction')}</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedData.map(row => `
                            <tr>
                                <td>${escapeHTML(row.category)}</td>
                                <td class="amount">${formatCurrency(row.total)}</td>
                                <td>${row.percentage.toFixed(1)}%</td>
                                <td>${row.count}</td>
                                <td class="amount">${formatCurrency(row.average)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                    <tfoot>
                        <tr style="font-weight: bold;">
                            <td>${totalLabel}</td>
                            <td class="amount">${formatCurrency(total)}</td>
                            <td>100%</td>
                            <td>${sortedData.reduce((sum, row) => sum + row.count, 0)}</td>
                            <td>-</td>
                        </tr>
                    </tfoot>
                </table>
            `;
        }

        function renderSummaryStats(summary) {
            const balanceClass = summary.netBalance >= 0 ? 'positive' : 'negative';
            const balanceSign = summary.netBalance >= 0 ? '+' : '';

            return `
                <div class="summary-row">
                    <span class="summary-label">${t('summary.total_income_label', 'Total Income:')}</span>
                    <span class="summary-value positive">${formatCurrency(summary.totalIncome)}</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">${t('summary.total_expenses_label', 'Total Expenses:')}</span>
                    <span class="summary-value negative">${formatCurrency(summary.totalExpenses)}</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">${t('summary.net_balance', 'Net Balance:')}</span>
                    <span class="summary-value ${balanceClass}">${balanceSign}${formatCurrency(summary.netBalance)}</span>
                </div>
                ${summary.totalIncome > 0 ? `
                <div class="summary-row">
                    <span class="summary-label">${t('summary.savings_rate', 'Savings Rate:')}</span>
                    <span class="summary-value ${balanceClass}">${summary.savingsRate.toFixed(1)}%</span>
                </div>
                ` : ''}
            `;
        }

        function handleSort(column) {
            if (sortColumn === column) {
                sortAscending = !sortAscending;
            } else {
                sortColumn = column;
                sortAscending = column === 'category'; // Ascending for category, descending for numbers
            }
            updateSummary();
        }

        function updateSummary() {
            const monthExpenses = getMonthExpenses(allExpenses);
            const summary = calculateCategorySummary(monthExpenses);

            document.getElementById('summaryStats').innerHTML = renderSummaryStats(summary);
            document.getElementById('expenseTableContainer').innerHTML = createSummaryTable(summary.expenseData, 'expenses');
            document.getElementById('incomeTableContainer').innerHTML = createSummaryTable(summary.incomeData, 'income');
        }

        async function initialize() {
            await initI18n();

            try {
                const configResponse = await fetch('/config');
                if (!configResponse.ok) throw new Error('Failed to fetch configuration');
                const config = await configResponse.json();
                currentCurrency = config.currency;
                startDate = config.startDate;

                const response = await fetch('/expenses');
                if (!response.ok) throw new Error('Failed to fetch data');
                const data = await response.json();
                allExpenses = Array.isArray(data) ? data : (data && Array.isArray(data.expenses) ? data.expenses : []);

                updateMonthDisplay();
                updateSummary();
            } catch (error) {
                console.error('Failed to initialize summary:', error);
                document.getElementById('summaryStats').innerHTML =
                    `<div class="no-data">${t('messages.failed_load', 'Failed to load summary data')}</div>`;
            }
        }

        document.getElementById('prevMonth').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            updateMonthDisplay();
            updateSummary();
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            updateMonthDisplay();
            updateSummary();
        });

        initialize();
    </script>
</body>
</html>
